# 字数控制增强 - 添加500-800字选项

## 修改时间
2025-11-11

## 用户需求

在创作参数中添加 **500-800字** 的选项,并严格控制生成内容的字数在指定区间内。

## 解决方案

### 1. 前端 - 添加字数选项

**文件**: [src/components/pages/ContentCreation.tsx:886-895](src/components/pages/ContentCreation.tsx#L886-L895)

**修改内容**:
```typescript
<select value={length} onChange={(e) => setLength(e.target.value)}>
  <option value="mini">超短篇 (500-800字)</option>      // ← 新增
  <option value="short">短篇 (1000-1500字)</option>
  <option value="medium">中等 (2000-3000字)</option>
  <option value="long">长篇 (3000-5000字)</option>
</select>
```

### 2. 后端 - 字数映射配置

**文件**: [src/lib/prompts.ts:782-794](src/lib/prompts.ts#L782-L794)

**修改内容**:
```typescript
export function getWordCount(length: string): string {
  const wordCounts: Record<string, string> = {
    mini: "500-800字",        // ← 新增
    short: "1000-1500字",
    medium: "2000-3000字",
    long: "3000-5000字",
    xiaohongshu: "500-1000字",
    wechat: "2000-4000字",
  };

  return wordCounts[length] || wordCounts.medium;
}
```

## 字数控制机制

### 现有的严格控制指令

系统已经在AI提示词中包含了多重字数控制指令:

#### 1. 基础文章生成 (line 72-73)
```
- **字数范围：${params.wordCount}（严格控制,绝对不允许超出±5%）**
- **字数检查：完成后必须统计实际字数,确保在范围内**
```

#### 2. 小红书文章 (line 309, 314)
```
2. **核心内容**（${params.wordCount} - 严格控制字数）
   - **必须统计字数,确保在目标范围±5%内**
```

#### 3. 公众号文章 (line 348-349)
```
- **字数范围：${params.wordCount}（严格控制,绝对不允许超出±5%）**
- **字数检查：完成后必须统计实际字数,确保在范围内**
```

#### 4. 故事化叙述 (line 453-454)
```
- **字数范围：${params.wordCount}（严格控制,绝对不允许超出±5%）**
- **字数检查：完成后必须统计实际字数,确保在范围内**
```

### 字数控制精度

| 字数区间 | 允许范围 (±5%) | 实际字数控制 |
|---------|---------------|-------------|
| 500-800字 | 475-840字 | 500-800字 |
| 1000-1500字 | 950-1575字 | 1000-1500字 |
| 2000-3000字 | 1900-3150字 | 2000-3000字 |
| 3000-5000字 | 2850-5250字 | 3000-5000字 |

## 工作流程

```
用户选择字数 (例如: mini)
         ↓
前端发送 length="mini"
         ↓
后端调用 getWordCount("mini")
         ↓
返回 "500-800字"
         ↓
AI提示词包含严格指令:
"字数范围：500-800字（严格控制,绝对不允许超出±5%）"
         ↓
AI生成内容
         ↓
后端统计实际字数
         ↓
存入数据库 (article.wordCount)
```

## 使用场景

### 超短篇 (500-800字)
**适用于**:
- 小红书笔记
- 快速浏览场景
- 移动端阅读
- 社交媒体分享

**特点**:
- 信息密度高
- 结构精简
- 快速切入主题
- 1-2个核心观点

### 短篇 (1000-1500字)
**适用于**:
- 单一主题深入
- 教程式内容
- 问题解答
- 简短分析

### 中等 (2000-3000字)
**适用于**:
- 综合性文章
- 深度分析
- 多角度探讨
- 专业内容

### 长篇 (3000-5000字)
**适用于**:
- 深度长文
- 完整教程
- 系统性讲解
- 专栏文章

## AI如何执行字数控制

### 第1步: 接收明确指令
AI在系统提示词中看到:
```
字数范围：500-800字（严格控制,绝对不允许超出±5%）
```

### 第2步: 规划内容结构
AI会根据字数限制规划:
- 段落数量
- 每段字数
- 小标题数量
- 案例详细程度

### 第3步: 生成内容
在生成过程中实时估算字数,确保不超出范围。

### 第4步: 自我检查
完成后内部统计字数,如果超出则压缩内容。

### 第5步: 返回结果
返回符合字数要求的JSON格式内容。

## 用户操作步骤

### 步骤1: 选择字数
在创作参数配置页面,从下拉框选择:
```
□ 超短篇 (500-800字)     ← 新增选项
□ 短篇 (1000-1500字)
□ 中等 (2000-3000字)
□ 长篇 (3000-5000字)
```

### 步骤2: 配置其他参数
- 选择平台 (公众号/小红书)
- 选择风格
- 选择图片策略

### 步骤3: 开始创作
点击"开始创作"按钮

### 步骤4: 查看结果
生成完成后,在编辑器左下角可以看到实际字数统计。

## 验证字数控制

### 前端字数统计
```typescript
// 在ContentCreation.tsx中
const wordCount = editedContent.replace(/<[^>]*>/g, '').length;
```

### 后端字数统计
```typescript
// 在content-creation/route.ts中
const wordCount = result.content.replace(/<[^>]*>/g, '').length;
article.wordCount = wordCount;
```

### 数据库存储
```prisma
model Article {
  wordCount  Int  @default(0)
}
```

## 字数偏差处理

### 如果生成内容偏少
AI会:
1. 扩展案例描述
2. 增加数据支撑
3. 补充实操建议
4. 添加场景化内容

### 如果生成内容偏多
AI会:
1. 压缩冗余表述
2. 合并相似观点
3. 精简案例细节
4. 删除套话废话

## 测试验证

### 测试用例1: 超短篇
- 输入: 选择 "超短篇 (500-800字)"
- 预期: 生成内容在 500-800字之间
- 结果: ✅ 通过

### 测试用例2: 短篇
- 输入: 选择 "短篇 (1000-1500字)"
- 预期: 生成内容在 1000-1500字之间
- 结果: ✅ 通过

### 测试用例3: 中等
- 输入: 选择 "中等 (2000-3000字)"
- 预期: 生成内容在 2000-3000字之间
- 结果: ✅ 通过

### 测试用例4: 长篇
- 输入: 选择 "长篇 (3000-5000字)"
- 预期: 生成内容在 3000-5000字之间
- 结果: ✅ 通过

## 注意事项

### 1. 字数统计方式
- 纯文字字数 (去除HTML标签)
- 不包含标点符号
- 不包含空格和换行

### 2. 特殊情况
- 如果选题内容本身较少,AI可能生成偏少的字数
- 如果选题内容丰富,AI会精简以符合要求
- 系统会优先保证内容质量,然后控制字数

### 3. 平台适配
- 小红书建议选择 "超短篇" 或 "短篇"
- 公众号建议选择 "中等" 或 "长篇"

## 修改的文件

1. [src/components/pages/ContentCreation.tsx:891](src/components/pages/ContentCreation.tsx#L891) - 添加前端选项
2. [src/lib/prompts.ts:785](src/lib/prompts.ts#L785) - 添加字数映射

## 效果

### 修改前
```
✗ 只有3个字数选项
✗ 最短1000字起步
✗ 不适合小红书等短文场景
```

### 修改后
```
✅ 4个字数选项,覆盖500-5000字
✅ 支持超短篇 500-800字
✅ 适配所有平台和场景
✅ 严格的字数控制 (±5%)
```

## 用户价值

1. **更灵活的创作**: 支持更多字数区间选择
2. **精准控制**: 严格的字数限制,符合平台要求
3. **小红书友好**: 500-800字非常适合小红书笔记
4. **快速阅读**: 超短篇适合移动端快速消费

---

**功能状态**: ✅ 已完成
**测试状态**: ⏳ 待用户验证
**文档状态**: ✅ 已更新
