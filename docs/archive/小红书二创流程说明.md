# 小红书二创流程说明

## 🎯 完整流程

根据您的要求，小红书二创的完整流程已经实现：

### 流程 1：文案二创（Gemini 2.5 Pro）
- ✅ 使用 Gemini 2.5 Pro 对原始文案进行优化
- ✅ 根据目标平台（小红书/微信）调整风格
- ✅ 保持内容的真实性和可读性

### 流程 2：图片分析（Gemini 2.5 Pro Vision）
- ✅ 将原图片发送给 Gemini 2.5 Pro 进行分析
- ✅ **可在设置中自定义分析提示词**
- ✅ 生成适合 Imagen 3 的英文提示词
- ✅ 提取图片的关键元素、风格、氛围

### 流程 3：图片生成（Imagen 3）
- ✅ 使用 Gemini 分析返回的提示词
- ✅ 结合原图通过 apicore.ai 的 Imagen 3 生成新图片
- ✅ 支持批量生成多个变体

---

## 📁 新增文件

### 1. Gemini 客户端
**文件**: `src/lib/gemini-client.ts`

主要功能：
- `optimizeContent()` - 文案二创优化
- `analyzeImage()` - 图片分析并生成提示词
- `analyzeImages()` - 批量图片分析

### 2. 更新的小红书处理器
**文件**: `src/lib/xiaohongshu-processor.ts`

新增功能：
- 集成文案二创功能
- 集成 Gemini 图片分析
- 使用 Imagen 3 生成图片
- 支持三个流程的开关控制

### 3. 数据库更新
**文件**: `prisma/schema.prisma`

新增字段：
- `imageAnalysisPrompt` - 用户可自定义的图片分析提示词

### 4. API 更新
**文件**: `src/app/api/prompt-settings/route.ts`

新增支持：
- 图片分析提示词的保存和读取

---

## 🔧 配置说明

### 1. 环境变量配置

在 `.env` 文件中添加：

```env
# Google Gemini API (用于文案二创和图片分析)
GEMINI_API_KEY="your_gemini_api_key_here"
```

**如何获取 Gemini API Key：**
1. 访问 [Google AI Studio](https://makersuite.google.com/app/apikey)
2. 创建新的 API Key
3. 复制并粘贴到 `.env` 文件

### 2. 图片分析提示词配置

默认提示词（可在设置中修改）：
```
请仔细分析这张图片，并提供详细的描述和适合 Imagen 3 图片生成的英文提示词。
请以 JSON 格式返回：
{
  "description": "图片描述",
  "suggestedPrompt": "英文提示词",
  "keyElements": ["元素列表"],
  "style": "风格",
  "mood": "氛围"
}
```

**您可以通过以下方式自定义：**
1. 进入应用的设置页面
2. 找到"图片分析提示词"配置项
3. 根据您的需求修改提示词模板
4. 保存设置

---

## 🚀 使用方法

### 代码调用示例

```typescript
import { xiaohongshuProcessor } from '@/lib/xiaohongshu-processor';

const result = await xiaohongshuProcessor.processPost(
  {
    id: '1',
    title: '原始标题',
    content: '原始内容',
    images: ['https://example.com/image1.jpg'],
    author: '作者',
    likes: 100,
    collections: 50,
    comments: 20,
    tags: ['标签1', '标签2'],
    createdAt: new Date().toISOString(),
  },
  {
    // 文案二创选项
    optimizeContent: true,           // 是否使用 Gemini 2.5 Pro 优化文案

    // 图片处理选项
    useGeminiForAnalysis: true,      // 是否使用 Gemini 2.5 Pro 分析图片
    useImagenForGeneration: true,    // 是否使用 Imagen 3 生成图片

    // 其他选项
    generateVariations: true,        // 是否生成变体
    variationCount: 3,               // 每张图生成几个变体
    targetPlatform: 'xiaohongshu',   // 目标平台
  }
);

// 结果包含：
console.log(result.optimizedContent);    // 二创后的文案
console.log(result.generatedImages);     // 生成的图片
console.log(result.contentAnalysis);     // 内容分析结果
```

---

## 📊 处理流程示意

```
原始小红书帖子
    ↓
┌─────────────────────────────────────┐
│ 流程 1: 文案二创                      │
│ • 使用 Gemini 2.5 Pro                │
│ • 优化标题和内容                      │
│ • 适配目标平台风格                    │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 流程 2: 图片分析                      │
│ • 使用 Gemini 2.5 Pro Vision         │
│ • 根据用户配置的提示词分析图片         │
│ • 生成英文提示词                      │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 流程 3: 图片生成                      │
│ • 使用分析返回的提示词                 │
│ • 结合原图通过 Imagen 3 生成新图      │
│ • 支持批量生成变体                    │
└─────────────────────────────────────┘
    ↓
  二创结果
  • 优化后的文案
  • 新生成的图片
```

---

## ⚙️ 高级配置

### 1. 自定义图片分析提示词示例

**示例 1: 美食图片分析**
```
请分析这张美食图片，重点描述：
1. 食物的种类、颜色、摆盘
2. 餐具和背景的风格
3. 整体氛围（温馨、高级、家常等）

返回 JSON 格式：
{
  "description": "详细的中文描述",
  "suggestedPrompt": "适合 Imagen 3 的英文提示词，包含食物、餐具、光线、风格等要素",
  "keyElements": ["主要元素列表"],
  "style": "图片风格（如：简约、复古、现代）",
  "mood": "氛围（如：温馨、清新、高级）"
}
```

**示例 2: 时尚穿搭图片分析**
```
请分析这张时尚穿搭图片，重点描述：
1. 服装的款式、颜色、材质
2. 整体搭配风格
3. 场景和背景

返回 JSON 格式，suggestedPrompt 要详细描述服装细节和搭配风格。
```

### 2. 控制流程开关

您可以根据需要单独开启或关闭某个流程：

```typescript
// 只进行文案二创，不处理图片
await xiaohongshuProcessor.processPost(post, {
  optimizeContent: true,
  useGeminiForAnalysis: false,
  useImagenForGeneration: false,
});

// 只进行图片分析，不生成新图
await xiaohongshuProcessor.processPost(post, {
  optimizeContent: false,
  useGeminiForAnalysis: true,
  useImagenForGeneration: false,
});

// 完整流程（默认）
await xiaohongshuProcessor.processPost(post, {
  optimizeContent: true,
  useGeminiForAnalysis: true,
  useImagenForGeneration: true,
});
```

---

## ❗ 注意事项

1. **API Key 配置**
   - 确保 `GEMINI_API_KEY` 已正确配置
   - Gemini API 有调用频率限制，注意控制请求速度

2. **成本控制**
   - Gemini 2.5 Pro 的调用会产生费用
   - Imagen 3 的图片生成也会产生费用
   - 建议在测试时使用小批量数据

3. **错误处理**
   - 如果 Gemini 分析失败，会自动降级使用基础提示词
   - 如果图片生成失败，会记录错误但不会中断整个流程

4. **数据库更新**
   - 数据库已通过 `prisma db push` 同步
   - 新增的 `imageAnalysisPrompt` 字段已就绪

---

## 🧪 测试建议

### 1. 测试文案二创

```bash
# 单独测试 Gemini 文案优化
const optimized = await geminiClient.optimizeContent(
  "原始标题\n\n原始内容",
  { platform: 'xiaohongshu', style: '轻松活泼' }
);
console.log(optimized);
```

### 2. 测试图片分析

```bash
# 单独测试 Gemini 图片分析
const analysis = await geminiClient.analyzeImage(
  'https://example.com/image.jpg',
  customPrompt
);
console.log(analysis.suggestedPrompt);
```

### 3. 测试完整流程

使用小红书 API 抓取一个真实帖子，然后进行完整的二创处理。

---

## 📞 问题排查

### 问题 1: Gemini API 调用失败
**解决方案**:
- 检查 `GEMINI_API_KEY` 是否正确
- 检查网络连接
- 查看 API 配额是否用完

### 问题 2: 图片分析返回格式错误
**解决方案**:
- 调整提示词，明确要求返回 JSON 格式
- 增加示例格式说明

### 问题 3: 图片生成失败
**解决方案**:
- 检查 `APICORE_API_KEY` 是否正确
- 查看 Gemini 返回的提示词是否合理
- 尝试简化提示词

---

## 🎉 完成！

所有功能已经实现并准备就绪。您现在可以：

1. ✅ 配置 `GEMINI_API_KEY`
2. ✅ 在设置中自定义图片分析提示词
3. ✅ 测试完整的二创流程
4. ✅ 根据需要调整各个流程的开关

如有任何问题，请随时提问！
