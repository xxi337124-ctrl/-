# å°çº¢ä¹¦äºŒåˆ›å…¨å±€çŠ¶æ€é›†æˆè¯´æ˜

## é—®é¢˜èƒŒæ™¯

### ç”¨æˆ·åé¦ˆçš„æ ¸å¿ƒé—®é¢˜
> "å°çº¢ä¹¦äºŒåˆ›è¿‡ç¨‹ä¸­ï¼Œåˆ‡æ¢é¡µé¢å°±ä¸­æ–­äº†ï¼Œä¹Ÿæ²¡ç»§ç»­æç¤ºå’Œç»§ç»­åˆ›ä½œä¸­ï¼Œç›¸å½“äºè¿™ä¸ªæµç¨‹ç™½åšäº†ï¼Œé’±ä¹Ÿç™½èŠ±äº†"

### é—®é¢˜åˆ†æ
1. **è¿›åº¦ä¸¢å¤±**: åˆ‡æ¢é¡µé¢åï¼Œå¤„ç†è¿›åº¦å®Œå…¨ä¸¢å¤±
2. **æ— æ³•æ¢å¤**: æ²¡æœ‰ä»»ä½•æœºåˆ¶æ¢å¤ä¸­æ–­çš„ä»»åŠ¡
3. **æ— çŠ¶æ€æç¤º**: ç”¨æˆ·ä¸çŸ¥é“ä»»åŠ¡æ˜¯å¦è¿˜åœ¨è¿›è¡Œ
4. **èµ„æºæµªè´¹**: APIè°ƒç”¨å’Œæ—¶é—´æˆæœ¬æ— æ³•æŒ½å›

---

## è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
å°†å°çº¢ä¹¦äºŒåˆ›æµç¨‹å®Œå…¨é›†æˆåˆ°å…¨å±€çŠ¶æ€ç®¡ç†ç³»ç»Ÿä¸­ï¼Œå®ç°ï¼š
1. âœ… ä»»åŠ¡çŠ¶æ€æŒä¹…åŒ–ï¼ˆlocalStorage + Zustandï¼‰
2. âœ… æ¯ä¸ªæ­¥éª¤å®æ—¶æ›´æ–°å…¨å±€store
3. âœ… ä¸­æ–­ä»»åŠ¡è‡ªåŠ¨æ¢å¤
4. âœ… è·¨é¡µé¢è¿›åº¦æ˜¾ç¤º
5. âœ… å®Œæˆ/å¤±è´¥é€šçŸ¥

---

## æŠ€æœ¯å®ç°

### 1. æ‰©å±•å…¨å±€ Task æ¥å£

#### æ–‡ä»¶: `src/lib/stores/globalStore.ts`

#### æ–°å¢å­—æ®µ
```typescript
export interface Task {
  // åŸæœ‰å­—æ®µ...

  // å°çº¢ä¹¦äºŒåˆ›ä¸“ç”¨å­—æ®µ
  progressMessage?: string;              // è¿›åº¦æ¶ˆæ¯ï¼š"æ­£åœ¨ä½¿ç”¨ Gemini 2.5 Pro è¿›è¡Œæ–‡æ¡ˆäºŒåˆ›..."
  currentStep?: 'rewrite' | 'analyze' | 'generate' | 'complete';  // å½“å‰æ­¥éª¤
  rewrittenContent?: string;             // å·²å®Œæˆçš„äºŒåˆ›æ–‡æ¡ˆ
  imagePrompts?: string[];               // å·²ç”Ÿæˆçš„å›¾ç‰‡æç¤ºè¯
  generatedImages?: string[];            // å·²ç”Ÿæˆçš„å›¾ç‰‡URL
}
```

#### ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›å­—æ®µï¼Ÿ
- **progressMessage**: æ˜¾ç¤ºè¯¦ç»†çš„è¿›åº¦ä¿¡æ¯ï¼Œæ¯”ç®€å•çš„ç™¾åˆ†æ¯”æ›´å‹å¥½
- **currentStep**: è®°å½•å½“å‰æ‰§è¡Œåˆ°å“ªä¸€æ­¥ï¼Œç”¨äºæ¢å¤ä¸­æ–­ä»»åŠ¡
- **rewrittenContent**: ä¿å­˜ç¬¬ä¸€æ­¥çš„ç»“æœï¼Œé¿å…é‡å¤è°ƒç”¨API
- **imagePrompts**: ä¿å­˜ç¬¬äºŒæ­¥çš„ç»“æœï¼Œé¿å…é‡å¤åˆ†æ
- **generatedImages**: ä¿å­˜ç¬¬ä¸‰æ­¥çš„ç»“æœ

---

### 2. RewriteProcess ç»„ä»¶é›†æˆ

#### æ–‡ä»¶: `src/components/pages/XiaohongshuRewrite/RewriteProcess.tsx`

#### 2.1 å¼•å…¥å…¨å±€ store
```typescript
import { useGlobalStore } from '@/lib/stores/globalStore';

export default function RewriteProcess({ note, onComplete, onBack, onProcessingChange }) {
  const { activeTask, updateTask, startTask, completeTask, failTask } = useGlobalStore();
  const taskId = `xhs-${note.id}-${Date.now()}`;

  // æœ¬åœ°çŠ¶æ€ç”¨äºUIæ¸²æŸ“
  const [currentStep, setCurrentStep] = useState<ProcessStep>('rewrite');
  const [rewrittenContent, setRewrittenContent] = useState<string>('');
  const [imagePrompts, setImagePrompts] = useState<string[]>([]);
  const [generatedImages, setGeneratedImages] = useState<string[]>([]);
  const [progress, setProgress] = useState(0);
  const [progressMessage, setProgressMessage] = useState('');
}
```

#### 2.2 ç»„ä»¶æŒ‚è½½æ—¶çš„ä»»åŠ¡æ¢å¤é€»è¾‘
```typescript
useEffect(() => {
  if (activeTask && activeTask.type === 'xiaohongshu-rewrite') {
    // æ¢å¤ä»»åŠ¡çŠ¶æ€
    setCurrentStep((activeTask.currentStep || 'rewrite') as ProcessStep);
    setProgress(activeTask.progress || 0);
    setProgressMessage(activeTask.progressMessage || '');
    setRewrittenContent(activeTask.rewrittenContent || '');
    setImagePrompts(activeTask.imagePrompts || []);
    setGeneratedImages(activeTask.generatedImages || []);

    // å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œç›´æ¥è¿”å›ç»“æœ
    if (activeTask.status === 'COMPLETED' && activeTask.result) {
      onComplete(activeTask.result);
    }
  } else {
    // å¯åŠ¨æ–°ä»»åŠ¡
    startTask(taskId, 'xiaohongshu-rewrite', undefined, `å°çº¢ä¹¦äºŒåˆ›: ${note.title.substring(0, 20)}...`);
  }
}, []);
```

**å…³é”®ç‚¹**:
- é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
- å¦‚æœæœ‰ï¼Œæ¢å¤æ‰€æœ‰çŠ¶æ€åˆ°æœ¬åœ°
- å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œç›´æ¥è·³åˆ°ç»“æœé¡µ
- å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œåˆ›å»ºæ–°ä»»åŠ¡

#### 2.3 æ¢å¤ä¸­æ–­ä»»åŠ¡çš„æ‰§è¡Œé€»è¾‘
```typescript
useEffect(() => {
  if (!activeTask || activeTask.type !== 'xiaohongshu-rewrite') {
    handleRewriteContent();  // å¼€å§‹æ–°ä»»åŠ¡
  } else if (activeTask.currentStep && activeTask.currentStep !== 'complete') {
    // æ¢å¤ä¸­æ–­çš„ä»»åŠ¡ - æ ¹æ®å½“å‰æ­¥éª¤ç»§ç»­æ‰§è¡Œ
    const step = activeTask.currentStep;

    if (step === 'rewrite' && !activeTask.rewrittenContent) {
      handleRewriteContent();  // ç¬¬ä¸€æ­¥æœªå®Œæˆï¼Œé‡æ–°æ‰§è¡Œ
    } else if (step === 'analyze' && (!activeTask.imagePrompts || activeTask.imagePrompts.length === 0)) {
      handleAnalyzeImages();  // ç¬¬äºŒæ­¥æœªå®Œæˆï¼Œç»§ç»­åˆ†æ
    } else if (step === 'generate' && activeTask.imagePrompts && activeTask.imagePrompts.length > 0) {
      handleGenerateImages(activeTask.imagePrompts);  // ç¬¬ä¸‰æ­¥æœªå®Œæˆï¼Œç»§ç»­ç”Ÿæˆ
    }
  }
}, []);
```

**æ™ºèƒ½æ¢å¤æœºåˆ¶**:
- æ£€æŸ¥æ¯ä¸€æ­¥æ˜¯å¦å·²å®Œæˆï¼ˆé€šè¿‡æ£€æŸ¥å¯¹åº”å­—æ®µæ˜¯å¦å­˜åœ¨ï¼‰
- ä»æœªå®Œæˆçš„æ­¥éª¤ç»§ç»­æ‰§è¡Œ
- é¿å…é‡å¤è°ƒç”¨å·²å®Œæˆçš„æ­¥éª¤

#### 2.4 æ­¥éª¤1: æ–‡æ¡ˆäºŒåˆ›
```typescript
const handleRewriteContent = async () => {
  setCurrentStep('rewrite');
  setProgress(10);
  setProgressMessage('æ­£åœ¨ä½¿ç”¨ Gemini 2.5 Pro è¿›è¡Œæ–‡æ¡ˆäºŒåˆ›...');
  setError(null);

  // æ›´æ–°å…¨å±€store
  updateTask({
    status: 'PROCESSING',
    progress: 10,
    progressMessage: 'æ­£åœ¨ä½¿ç”¨ Gemini 2.5 Pro è¿›è¡Œæ–‡æ¡ˆäºŒåˆ›...',
    currentStep: 'rewrite',
  });

  try {
    const response = await fetch('/api/xiaohongshu/rewrite-content', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        originalContent: note.content,
        style: 'è½»æ¾æ´»æ³¼',
      }),
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'æ–‡æ¡ˆäºŒåˆ›å¤±è´¥');
    }

    setRewrittenContent(data.data.rewrittenContent);
    setProgress(30);
    setProgressMessage('æ–‡æ¡ˆäºŒåˆ›å®Œæˆï¼');

    // æ›´æ–°å…¨å±€store - ä¿å­˜ç»“æœ
    updateTask({
      progress: 30,
      progressMessage: 'æ–‡æ¡ˆäºŒåˆ›å®Œæˆï¼',
      rewrittenContent: data.data.rewrittenContent,  // å…³é”®ï¼šä¿å­˜ç»“æœ
    });

    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œç»§ç»­åˆ†æå›¾ç‰‡
    if (note.images.length > 0) {
      setTimeout(() => {
        handleAnalyzeImages();
      }, 1000);
    } else {
      handleComplete();
    }
  } catch (error: any) {
    console.error('æ–‡æ¡ˆäºŒåˆ›å¤±è´¥:', error);
    setError(error.message || 'æ–‡æ¡ˆäºŒåˆ›å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    failTask(error.message || 'æ–‡æ¡ˆäºŒåˆ›å¤±è´¥');  // æ›´æ–°ä¸ºå¤±è´¥çŠ¶æ€
  }
};
```

**å…³é”®æ”¹åŠ¨**:
- æ¯æ¬¡çŠ¶æ€å˜åŒ–éƒ½è°ƒç”¨ `updateTask()` åŒæ­¥åˆ°å…¨å±€
- **å¿…é¡»ä¿å­˜ `rewrittenContent`** - ç”¨äºæ¢å¤æ—¶åˆ¤æ–­æ˜¯å¦å·²å®Œæˆ
- å¤±è´¥æ—¶è°ƒç”¨ `failTask()` è§¦å‘é”™è¯¯æç¤º

#### 2.5 æ­¥éª¤2: å›¾ç‰‡åˆ†æ
```typescript
const handleAnalyzeImages = async () => {
  setCurrentStep('analyze');
  setProgress(40);
  setProgressMessage(`æ­£åœ¨åˆ†æ ${note.images.length} å¼ å›¾ç‰‡...`);
  setError(null);

  // æ›´æ–°å…¨å±€store
  updateTask({
    progress: 40,
    progressMessage: `æ­£åœ¨åˆ†æ ${note.images.length} å¼ å›¾ç‰‡...`,
    currentStep: 'analyze',  // æ›´æ–°å½“å‰æ­¥éª¤
  });

  try {
    const response = await fetch('/api/xiaohongshu/analyze-image', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        imageUrls: note.images,
      }),
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'å›¾ç‰‡åˆ†æå¤±è´¥');
    }

    const prompts = data.data.prompts.filter((p: string) => p.length > 0);
    setImagePrompts(prompts);
    setProgress(60);
    setProgressMessage(`å›¾ç‰‡åˆ†æå®Œæˆï¼Œè·å¾— ${prompts.length} ä¸ªæç¤ºè¯ï¼`);

    // æ›´æ–°å…¨å±€store - ä¿å­˜æç¤ºè¯
    updateTask({
      progress: 60,
      progressMessage: `å›¾ç‰‡åˆ†æå®Œæˆï¼Œè·å¾— ${prompts.length} ä¸ªæç¤ºè¯ï¼`,
      imagePrompts: prompts,  // å…³é”®ï¼šä¿å­˜æç¤ºè¯
    });

    // ç»§ç»­ç”Ÿæˆå›¾ç‰‡
    if (prompts.length > 0) {
      setTimeout(() => {
        handleGenerateImages(prompts);
      }, 1000);
    } else {
      handleComplete();
    }
  } catch (error: any) {
    console.error('å›¾ç‰‡åˆ†æå¤±è´¥:', error);
    setError(error.message || 'å›¾ç‰‡åˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    failTask(error.message || 'å›¾ç‰‡åˆ†æå¤±è´¥');
  }
};
```

#### 2.6 æ­¥éª¤3: å›¾ç‰‡ç”Ÿæˆ
```typescript
const handleGenerateImages = async (prompts: string[]) => {
  setCurrentStep('generate');
  setProgress(70);
  setProgressMessage(`æ­£åœ¨ç”Ÿæˆ ${prompts.length} å¼ æ–°å›¾ç‰‡...`);
  setError(null);

  // æ›´æ–°å…¨å±€store
  updateTask({
    progress: 70,
    progressMessage: `æ­£åœ¨ç”Ÿæˆ ${prompts.length} å¼ æ–°å›¾ç‰‡...`,
    currentStep: 'generate',
  });

  try {
    const referenceImages = note.images.slice(0, prompts.length);
    const validPrompts = prompts.slice(0, referenceImages.length);

    const response = await fetch('/api/xiaohongshu/generate-image', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompts: validPrompts,
        referenceImageUrls: referenceImages,
      }),
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥');
    }

    const images = data.data.generatedImageUrls.filter((url: string) => url.length > 0);
    setGeneratedImages(images);
    setProgress(100);
    setProgressMessage('å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼');

    // æ›´æ–°å…¨å±€store - ä¿å­˜ç”Ÿæˆçš„å›¾ç‰‡
    updateTask({
      progress: 100,
      progressMessage: 'å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼',
      generatedImages: images,  // å…³é”®ï¼šä¿å­˜ç”Ÿæˆç»“æœ
    });

    setTimeout(() => {
      handleComplete();
    }, 1000);
  } catch (error: any) {
    console.error('å›¾ç‰‡ç”Ÿæˆå¤±è´¥:', error);
    setError(error.message || 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    failTask(error.message || 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥');
  }
};
```

#### 2.7 å®Œæˆå¤„ç†
```typescript
const handleComplete = () => {
  setCurrentStep('complete');
  setProgress(100);
  setProgressMessage('äºŒåˆ›å®Œæˆï¼');

  const result: RewriteResult = {
    original: {
      content: note.content,
      images: note.images,
    },
    rewritten: {
      content: rewrittenContent,
      images: generatedImages,
      imagePrompts: imagePrompts,
    },
  };

  // æ›´æ–°å…¨å±€store - æ ‡è®°ä¸ºå®Œæˆ
  completeTask(result);  // è¿™ä¼šè‡ªåŠ¨è§¦å‘Toasté€šçŸ¥å’Œæ•°æ®æ¸…ç†

  setTimeout(() => {
    onComplete(result);
  }, 500);
};
```

**å…³é”®ç‚¹**:
- `completeTask()` ä¼šè‡ªåŠ¨ï¼š
  - è®¾ç½®çŠ¶æ€ä¸º 'COMPLETED'
  - æ˜¾ç¤ºæˆåŠŸToast
  - è§¦å‘ç›¸å…³é¡µé¢åˆ·æ–°
  - 3ç§’åæ¸…ç†ä»»åŠ¡å’ŒlocalStorage

---

### 3. ä¸»é¡µé¢è¿›åº¦æ¡æ˜¾ç¤º

#### æ–‡ä»¶: `src/app/page.tsx`

#### 3.1 è¿›åº¦æ¡æ˜¾ç¤ºæ¡ä»¶
```typescript
{activeTask &&
 activeTask.status !== 'COMPLETED' &&
 activeTask.status !== 'FAILED' &&
 activeTab !== 'smart-creation' &&
 activeTab !== 'xiaohongshu-rewrite' && (
  <div className="fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
    <div className="max-w-7xl mx-auto px-6 py-3">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
          <span className="font-medium">{activeTask.progressMessage || 'AIåˆ›ä½œç”Ÿæˆä¸­...'}</span>
          <span className="text-sm opacity-90">{taskProgress}%</span>
        </div>
        <button
          onClick={() => {
            // æ ¹æ®ä»»åŠ¡ç±»å‹è·³è½¬
            if (activeTask.type === 'xiaohongshu-rewrite') {
              setActiveTab('xiaohongshu-rewrite');
            } else {
              setActiveTab('smart-creation');
            }
          }}
          className="px-4 py-1.5 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg text-sm font-medium transition-all"
        >
          æŸ¥çœ‹è¿›åº¦ â†’
        </button>
      </div>
      {/* è¿›åº¦æ¡ */}
      <div className="mt-2 h-1 bg-white bg-opacity-30 rounded-full overflow-hidden">
        <div
          className="h-full bg-white transition-all duration-500"
          style={{ width: `${taskProgress}%` }}
        />
      </div>
    </div>
  </div>
)}
```

**æ˜¾ç¤ºé€»è¾‘**:
- åªåœ¨æœ‰æ´»åŠ¨ä»»åŠ¡æ—¶æ˜¾ç¤º
- ä¸åœ¨ä»»åŠ¡å®Œæˆæˆ–å¤±è´¥æ—¶æ˜¾ç¤º
- ä¸åœ¨ä»»åŠ¡å¯¹åº”é¡µé¢æ˜¾ç¤ºï¼ˆé¿å…é‡å¤ï¼‰
- **æ ¹æ®ä»»åŠ¡ç±»å‹è·³è½¬åˆ°æ­£ç¡®çš„é¡µé¢**

#### 3.2 å¸ƒå±€è°ƒæ•´
```typescript
{/* Left Sidebar */}
<div
  className="w-80 border-r border-gray-200 bg-gray-50/50 flex flex-col relative z-50"
  style={{
    marginTop: (activeTask &&
                activeTask.status !== 'COMPLETED' &&
                activeTask.status !== 'FAILED' &&
                activeTab !== 'smart-creation' &&
                activeTab !== 'xiaohongshu-rewrite') ? '80px' : '0'
  }}
>
  {/* Navigation... */}
</div>

{/* Right Content Area */}
<div
  className="flex-1 overflow-y-auto"
  style={{
    marginTop: (activeTask &&
                activeTask.status !== 'COMPLETED' &&
                activeTask.status !== 'FAILED' &&
                activeTab !== 'smart-creation' &&
                activeTab !== 'xiaohongshu-rewrite') ? '80px' : '0'
  }}
>
  <div className="transition-opacity duration-300">{renderContent()}</div>
</div>
```

**ä¸ºä»€ä¹ˆéœ€è¦ marginTop**:
- è¿›åº¦æ¡æ˜¯ `position: fixed`ï¼Œä¼šè¦†ç›–å†…å®¹
- éœ€è¦ç»™ä¾§è¾¹æ å’Œå†…å®¹åŒºåŸŸæ·»åŠ ä¸Šè¾¹è·
- åªåœ¨è¿›åº¦æ¡æ˜¾ç¤ºæ—¶æ·»åŠ ï¼ˆ80pxï¼‰

---

## å·¥ä½œæµç¨‹ç¤ºæ„

### æ­£å¸¸æµç¨‹ï¼ˆä¸ä¸­æ–­ï¼‰
```
1. ç”¨æˆ·ä¸Šä¼ å°çº¢ä¹¦å†…å®¹
   â†“
2. RewriteProcess æŒ‚è½½
   â†“ startTask()
3. å…¨å±€storeåˆ›å»ºä»»åŠ¡ (status: PENDING)
   â†“
4. handleRewriteContent()
   â†“ updateTask({ currentStep: 'rewrite', progress: 10, rewrittenContent })
5. æ–‡æ¡ˆäºŒåˆ›å®Œæˆ
   â†“
6. handleAnalyzeImages()
   â†“ updateTask({ currentStep: 'analyze', progress: 40, imagePrompts })
7. å›¾ç‰‡åˆ†æå®Œæˆ
   â†“
8. handleGenerateImages()
   â†“ updateTask({ currentStep: 'generate', progress: 70, generatedImages })
9. å›¾ç‰‡ç”Ÿæˆå®Œæˆ
   â†“
10. handleComplete()
    â†“ completeTask(result)
11. æ˜¾ç¤ºToast "åˆ›ä½œå®Œæˆï¼"
    â†“
12. 3ç§’åæ¸…ç†ä»»åŠ¡
```

### ä¸­æ–­æ¢å¤æµç¨‹
```
1. ç”¨æˆ·ä¸Šä¼ å°çº¢ä¹¦å†…å®¹
   â†“
2. æ–‡æ¡ˆäºŒåˆ›è¿›è¡Œä¸­... (rewrittenContent å·²ä¿å­˜åˆ° store)
   â†“
3. ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢ âŒ
   â†“ activeTask ä»åœ¨å…¨å±€storeä¸­
4. é¡¶éƒ¨æ˜¾ç¤ºè¿›åº¦æ¡ï¼š"æ­£åœ¨ä½¿ç”¨ Gemini 2.5 Pro è¿›è¡Œæ–‡æ¡ˆäºŒåˆ›... 30%"
   â†“
5. ç”¨æˆ·ç‚¹å‡»"æŸ¥çœ‹è¿›åº¦ â†’" æˆ–ç›´æ¥åˆ‡æ¢å›å°çº¢ä¹¦äºŒåˆ›é¡µé¢
   â†“
6. RewriteProcess é‡æ–°æŒ‚è½½
   â†“
7. æ£€æµ‹åˆ° activeTask.type === 'xiaohongshu-rewrite'
   â†“
8. æ¢å¤çŠ¶æ€ï¼š
   - currentStep = 'rewrite'
   - rewrittenContent = activeTask.rewrittenContent âœ…
   - progress = 30
   â†“
9. æ£€æŸ¥ activeTask.rewrittenContent å­˜åœ¨
   â†“ è·³è¿‡ handleRewriteContent()
10. æ£€æŸ¥ activeTask.imagePrompts ä¸å­˜åœ¨
    â†“ ç»§ç»­æ‰§è¡Œ handleAnalyzeImages()
11. åç»­æ­¥éª¤æ­£å¸¸è¿›è¡Œ...
```

---

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

### æ”¹è¿›å‰ âŒ
- åˆ‡æ¢é¡µé¢ â†’ ä»»åŠ¡ä¸­æ–­
- æ²¡æœ‰ä»»ä½•æç¤º
- æ— æ³•æ¢å¤
- é’±ç™½èŠ±ï¼Œæ—¶é—´ç™½è´¹

### æ”¹è¿›å âœ…
1. **æŒä¹…åŒ–è¿›åº¦**
   - åˆ‡æ¢é¡µé¢ä¸å½±å“ä»»åŠ¡æ‰§è¡Œ
   - æ‰€æœ‰ä¸­é—´ç»“æœéƒ½ä¿å­˜
   - åˆ·æ–°æµè§ˆå™¨ä¹Ÿèƒ½æ¢å¤

2. **å®æ—¶åé¦ˆ**
   - é¡¶éƒ¨è¿›åº¦æ¡æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
   - ç™¾åˆ†æ¯” + æ–‡å­—æè¿°
   - æ—‹è½¬åŠ è½½åŠ¨ç”»

3. **å¿«é€Ÿå¯¼èˆª**
   - "æŸ¥çœ‹è¿›åº¦ â†’" æŒ‰é’®
   - ä¸€é”®å›åˆ°ä»»åŠ¡é¡µé¢
   - æ ¹æ®ä»»åŠ¡ç±»å‹æ™ºèƒ½è·³è½¬

4. **å®Œæˆé€šçŸ¥**
   - Toastå¼¹çª—æç¤º
   - æˆåŠŸ/å¤±è´¥ä¸åŒæ ·å¼
   - 3ç§’è‡ªåŠ¨æ¶ˆå¤±

5. **æ™ºèƒ½æ¢å¤**
   - æ£€æµ‹æ¯ä¸ªæ­¥éª¤æ˜¯å¦å®Œæˆ
   - ä»æœªå®Œæˆçš„æ­¥éª¤ç»§ç»­
   - é¿å…é‡å¤è°ƒç”¨API

---

## æŠ€æœ¯äº®ç‚¹

### 1. çŠ¶æ€æŒä¹…åŒ–
- **Zustand persist ä¸­é—´ä»¶**: è‡ªåŠ¨åŒæ­¥åˆ° localStorage
- **å¤šå±‚çŠ¶æ€å¤‡ä»½**: å†…å­˜ + localStorage åŒä¿é™©
- **æŒ‰éœ€åŠ è½½**: åªæŒä¹…åŒ–å¿…è¦å­—æ®µ

### 2. æ™ºèƒ½æ¢å¤æœºåˆ¶
```typescript
// åˆ¤æ–­é€»è¾‘
if (step === 'rewrite' && !activeTask.rewrittenContent) {
  // ç¬¬ä¸€æ­¥æœªå®Œæˆ
} else if (step === 'analyze' && !activeTask.imagePrompts?.length) {
  // ç¬¬äºŒæ­¥æœªå®Œæˆ
} else if (step === 'generate' && activeTask.imagePrompts?.length) {
  // ç¬¬ä¸‰æ­¥æœªå®Œæˆï¼Œä½†æœ‰æç¤ºè¯å¯ä»¥ç»§ç»­
}
```

### 3. ç±»å‹å®‰å…¨
```typescript
type: 'xiaohongshu-rewrite';  // æ˜ç¡®çš„ä»»åŠ¡ç±»å‹
currentStep?: 'rewrite' | 'analyze' | 'generate' | 'complete';  // æ­¥éª¤æšä¸¾
```

### 4. è§£è€¦è®¾è®¡
- å…¨å±€storeç‹¬ç«‹ç®¡ç†çŠ¶æ€
- ç»„ä»¶åªå…³æ³¨UIå’Œä¸šåŠ¡é€»è¾‘
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

---

## æµ‹è¯•åœºæ™¯

### åœºæ™¯1: æ­£å¸¸å®Œæˆ
1. ä¸Šä¼ å°çº¢ä¹¦å†…å®¹
2. ç­‰å¾…ä¸‰æ­¥å®Œæˆ
3. æŸ¥çœ‹Toastæç¤º
4. éªŒè¯ç»“æœæ­£ç¡®

### åœºæ™¯2: ç¬¬ä¸€æ­¥ä¸­æ–­
1. ä¸Šä¼ å†…å®¹ï¼Œå¼€å§‹äºŒåˆ›
2. ç«‹å³åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢
3. æ£€æŸ¥é¡¶éƒ¨è¿›åº¦æ¡æ˜¾ç¤º
4. åˆ‡æ¢å›å°çº¢ä¹¦é¡µé¢
5. éªŒè¯ä»ç¬¬ä¸€æ­¥ç»§ç»­

### åœºæ™¯3: ç¬¬äºŒæ­¥ä¸­æ–­
1. ç­‰å¾…ç¬¬ä¸€æ­¥å®Œæˆ
2. ç¬¬äºŒæ­¥è¿›è¡Œä¸­ï¼Œåˆ‡æ¢é¡µé¢
3. æ£€æŸ¥è¿›åº¦æ¡
4. åˆ‡æ¢å›æ¥
5. éªŒè¯ä»ç¬¬äºŒæ­¥ç»§ç»­ï¼ˆä¸é‡å¤ç¬¬ä¸€æ­¥ï¼‰

### åœºæ™¯4: ç¬¬ä¸‰æ­¥ä¸­æ–­
1. ç­‰å¾…å‰ä¸¤æ­¥å®Œæˆ
2. ç¬¬ä¸‰æ­¥è¿›è¡Œä¸­ï¼Œåˆ‡æ¢é¡µé¢
3. æ£€æŸ¥è¿›åº¦æ¡
4. åˆ‡æ¢å›æ¥
5. éªŒè¯ä»ç¬¬ä¸‰æ­¥ç»§ç»­

### åœºæ™¯5: APIå¤±è´¥
1. æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
2. æ£€æŸ¥failTaskæ˜¯å¦è¢«è°ƒç”¨
3. éªŒè¯Toastæ˜¾ç¤ºé”™è¯¯
4. éªŒè¯å¯ä»¥é‡è¯•

### åœºæ™¯6: åˆ·æ–°æµè§ˆå™¨
1. ä»»åŠ¡è¿›è¡Œä¸­
2. åˆ·æ–°æµè§ˆå™¨ï¼ˆF5ï¼‰
3. éªŒè¯çŠ¶æ€æ¢å¤
4. éªŒè¯ä»»åŠ¡ç»§ç»­æ‰§è¡Œ

---

## ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. **src/lib/stores/globalStore.ts**
   - æ‰©å±• Task æ¥å£
   - æ·»åŠ å°çº¢ä¹¦ä¸“ç”¨å­—æ®µ

2. **src/components/pages/XiaohongshuRewrite/RewriteProcess.tsx**
   - é›†æˆå…¨å±€store
   - å®ç°æ¢å¤é€»è¾‘
   - æ¯æ­¥æ›´æ–°çŠ¶æ€

3. **src/app/page.tsx**
   - æ”¯æŒå°çº¢ä¹¦ä»»åŠ¡ç±»å‹
   - æ™ºèƒ½è·³è½¬é€»è¾‘

### ä¾èµ–çš„æ–‡ä»¶
1. **src/components/GlobalToast.tsx**
   - å®Œæˆé€šçŸ¥

2. **src/app/globals.css**
   - ToaståŠ¨ç”»

---

## åç»­ä¼˜åŒ–å»ºè®®

### 1. é”™è¯¯é‡è¯•æœºåˆ¶
```typescript
// æ·»åŠ é‡è¯•æ¬¡æ•°
interface Task {
  retryCount?: number;
  maxRetries?: number;
}

// å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
if (error && task.retryCount < task.maxRetries) {
  setTimeout(() => {
    handleRewriteContent();  // é‡è¯•
  }, 2000);
}
```

### 2. ä»»åŠ¡é˜Ÿåˆ—
```typescript
// æ”¯æŒå¤šä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œ
interface GlobalState {
  tasks: Task[];  // ä»»åŠ¡åˆ—è¡¨
  addTask: (task: Task) => void;
  removeTask: (taskId: string) => void;
}
```

### 3. ç¦»çº¿æ”¯æŒ
- ä½¿ç”¨ Service Worker
- ç¼“å­˜APIå“åº”
- ç½‘ç»œæ¢å¤åè‡ªåŠ¨åŒæ­¥

### 4. æ›´ç»†ç²’åº¦çš„è¿›åº¦
```typescript
// å›¾ç‰‡ç”Ÿæˆå¯ä»¥æ˜¾ç¤ºå•å¼ è¿›åº¦
progressMessage: `æ­£åœ¨ç”Ÿæˆç¬¬ ${currentIndex}/${total} å¼ å›¾ç‰‡...`
```

### 5. ä»»åŠ¡å†å²
```typescript
// ä¿å­˜å·²å®Œæˆçš„ä»»åŠ¡
interface GlobalState {
  taskHistory: Task[];
  saveToHistory: (task: Task) => void;
}
```

---

## æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–å®Œå…¨è§£å†³äº†ç”¨æˆ·åé¦ˆçš„æ ¸å¿ƒé—®é¢˜ï¼š

âœ… **åˆ‡æ¢é¡µé¢ä¸ä¸­æ–­**: ä»»åŠ¡ç»§ç»­åœ¨åå°æ‰§è¡Œ
âœ… **å®æ—¶è¿›åº¦æ˜¾ç¤º**: é¡¶éƒ¨è¿›åº¦æ¡éšæ—¶å¯è§
âœ… **æ™ºèƒ½æ¢å¤**: ä»ä¸­æ–­å¤„ç»§ç»­ï¼Œä¸æµªè´¹èµ„æº
âœ… **å®Œæˆé€šçŸ¥**: Toastæç¤ºä»»åŠ¡å®Œæˆ
âœ… **æˆæœ¬ä¿æŠ¤**: æ¯æ­¥ç»“æœéƒ½ä¿å­˜ï¼Œé¿å…é‡å¤è°ƒç”¨API

ç”¨æˆ·ç°åœ¨å¯ä»¥ï¼š
- åœ¨åˆ›ä½œè¿‡ç¨‹ä¸­è‡ªç”±åˆ‡æ¢åŠŸèƒ½
- éšæ—¶äº†è§£ä»»åŠ¡è¿›åº¦
- ä¸­æ–­åæ— ç¼æ¢å¤
- ä¸ç”¨æ‹…å¿ƒèµ„æºæµªè´¹

**è¿™æ˜¯ä¸€ä¸ªä»¥ç”¨æˆ·ä½“éªŒä¸ºä¸­å¿ƒçš„æŠ€æœ¯æ–¹æ¡ˆï¼** ğŸ‰
